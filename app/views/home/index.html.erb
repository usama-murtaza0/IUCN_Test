<script>

  $( document ).ready(function(){
    let countries = [];

    const map = new google.maps.Map(document.getElementById('map'), {
      zoom: 2.5,
      minZoom: 1,
      center: new google.maps.LatLng(50.7244893,3.2668189)
    });
    
    init();

    function init() {
      $.ajax({
        url : 'data.json',
        cache : true,
        dataType : 'json',
        async : true,
        success : function(data) {
          if (data) {
            $.each(data, function(id,country) {
              var countryCoords;
              var ca;
              var co;
              if ('multi' in country) {
                var ccArray = [];
                for (var t in country['xml']['Polygon']) {
                  countryCoords = [];
                  co = country['xml']['Polygon'][t]['outerBoundaryIs']['LinearRing']['coordinates'].split(' ');
                  for (var i in co) {
                    ca = co[i].split(',');
                    countryCoords.push(new google.maps.LatLng(ca[1], ca[0]));
                  }
                  ccArray.push(countryCoords);
                }
                createCountry(ccArray,country);
              } else {
                countryCoords = [];
                co = country['xml']['outerBoundaryIs']['LinearRing']['coordinates'].split(' ');
                for (var j in co) {
                  ca = co[j].split(',');
                  countryCoords.push(new google.maps.LatLng(ca[1], ca[0]));
                }
                createCountry(countryCoords,country);
              }
            }.bind(this));
            showCountries();
          }
        }.bind(this)
      });
    }
    
    function showCountries() {
      for (var i=0; i<countries.length; i++) {
        countries[i].setMap(map);
        google.maps.event.addListener(countries[i],"mouseover",function(){
          this.setOptions({fillColor: "#f5c879", 'fillOpacity': 0.5});
        });
        google.maps.event.addListener(countries[i],"mouseout",function(){
          this.setOptions({fillColor: "#f5c879", 'fillOpacity': 0});
        });
        google.maps.event.addListener(countries[i], 'click', function(event) {
          populate_country_data(this.title);
        });
      }
    }
    
    function populate_country_data(country_name){
      $.ajax({
        url : '<%= home_index_path %>',
        cache : true,
        dataType : 'json',
        type: 'post',
        async : true,
        data: { "country_name": country_name  },
        success : function(data) {
            var data_to_show = 'Name EN: ' + data.name + '<br/>' + 'Name ES: ' + data.name_es +  '<br/>' + 'Name FR: ' + data.name_fr + '<br/>' + 'Name AR: ' + data.name_ar + '<br/>' + 'WOE NOTE: ' + data.woe_note + '<br/>' + 'Income Group: ' + data.income_group + '<br/>' + 'Economy: ' + data.economy + '<br/>' + 'GDP Year: ' + data.gdp_year + '<br/>' + 'GDP MD: ' + data.gdp_md + '';
            $('#country_specific_data').html(data_to_show);
            $("#modal").modal('show');
        }
        .bind(this)
      });
    }

    function createCountry(coords, country) {
      var currentCountry = new google.maps.Polygon({
        paths: coords,
        title: country.country,
        code: country.iso,
        strokeOpacity: 0,
        fillOpacity: 0
      });
      countries.push(currentCountry);
    }
  });

</script>


<div id="map" class="center" style="width:100%; height:800px;"></div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCwigc-J6Bax4svQkMvtTN3lyzmtzgIhUc"></script>


<div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="country_specific_data"></h5>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>